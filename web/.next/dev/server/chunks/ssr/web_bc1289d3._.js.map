{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/Project/SigapPlanner/web/lib/api-client.ts"],"sourcesContent":["// lib/api-client.ts\r\nexport type ApiOptions = RequestInit & { body?: any };\r\n\r\nconst API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000/api';\r\n\r\nasync function handleResp(res: Response) {\r\n  const text = await res.text();\r\n  let data;\r\n  try { data = text ? JSON.parse(text) : undefined; } catch { data = text; }\r\n  if (!res.ok) {\r\n    const err: any = new Error(data?.message || res.statusText || 'API error');\r\n    err.status = res.status;\r\n    err.body = data;\r\n    throw err;\r\n  }\r\n  return data;\r\n}\r\n\r\nexport default async function apiClient(path: string, opts: ApiOptions = {}) {\r\n  const url = path.startsWith('http') ? path : `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;\r\n\r\n  const headers: Record<string,string> = {\r\n    'Accept': 'application/json',\r\n    ...(opts.headers as Record<string,string> || {}),\r\n  };\r\n\r\n  let body: BodyInit | undefined;\r\n  if (opts.body !== undefined) {\r\n    headers['Content-Type'] = 'application/json';\r\n    body = JSON.stringify(opts.body);\r\n  }\r\n\r\n  try {\r\n    const res = await fetch(url, {\r\n      credentials: 'include',\r\n      ...opts,\r\n      headers,\r\n      body,\r\n    });\r\n    return await handleResp(res);\r\n  } catch (err: any) {\r\n    // Network-level error (CORS, DNS, connection refused, etc)\r\n    const e: any = new Error(err.message || 'Network error');\r\n    e.detail = err;\r\n    e.url = url;\r\n    throw e;\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,oBAAoB;;;;;AAGpB,MAAM,WAAW,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAEpD,eAAe,WAAW,GAAa;IACrC,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,IAAI;IACJ,IAAI;QAAE,OAAO,OAAO,KAAK,KAAK,CAAC,QAAQ;IAAW,EAAE,OAAM;QAAE,OAAO;IAAM;IACzE,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,MAAW,IAAI,MAAM,MAAM,WAAW,IAAI,UAAU,IAAI;QAC9D,IAAI,MAAM,GAAG,IAAI,MAAM;QACvB,IAAI,IAAI,GAAG;QACX,MAAM;IACR;IACA,OAAO;AACT;AAEe,eAAe,UAAU,IAAY,EAAE,OAAmB,CAAC,CAAC;IACzE,MAAM,MAAM,KAAK,UAAU,CAAC,UAAU,OAAO,GAAG,WAAW,KAAK,UAAU,CAAC,OAAO,KAAK,MAAM,MAAM;IAEnG,MAAM,UAAiC;QACrC,UAAU;QACV,GAAI,KAAK,OAAO,IAA6B,CAAC,CAAC;IACjD;IAEA,IAAI;IACJ,IAAI,KAAK,IAAI,KAAK,WAAW;QAC3B,OAAO,CAAC,eAAe,GAAG;QAC1B,OAAO,KAAK,SAAS,CAAC,KAAK,IAAI;IACjC;IAEA,IAAI;QACF,MAAM,MAAM,MAAM,MAAM,KAAK;YAC3B,aAAa;YACb,GAAG,IAAI;YACP;YACA;QACF;QACA,OAAO,MAAM,WAAW;IAC1B,EAAE,OAAO,KAAU;QACjB,2DAA2D;QAC3D,MAAM,IAAS,IAAI,MAAM,IAAI,OAAO,IAAI;QACxC,EAAE,MAAM,GAAG;QACX,EAAE,GAAG,GAAG;QACR,MAAM;IACR;AACF"}},
    {"offset": {"line": 57, "column": 0}, "map": {"version":3,"sources":["file:///D:/Project/SigapPlanner/web/components/FrappeGanttChart.tsx"],"sourcesContent":["'use client';\r\nimport React, { useEffect, useRef, useState } from 'react';\r\nimport Gantt from 'frappe-gantt';\r\nimport 'frappe-gantt/dist/frappe-gantt.css';\r\nimport apiClient from '../lib/api-client';\r\n\r\ntype WO = {\r\n  id: string;\r\n  doc_no?: string;\r\n  asset_name?: string;\r\n  work_type?: string;\r\n  start_date?: string | null;\r\n  end_date?: string | null;\r\n  raw?: any;\r\n  description?: string | null;\r\n};\r\n\r\nfunction pickColorForWork(w: WO) {\r\n  const wt = (w.work_type || (w.raw && (w.raw.work_type || w.raw.type_work)) || '').toString();\r\n  if (/preventive/i.test(wt) || wt === 'PM') return '#16a34a';\r\n  if (/corrective/i.test(wt) || wt === 'CM') return '#f97316';\r\n  if (/breakdown|failure|bd/i.test(wt)) return '#ef4444';\r\n  return '#3b82f6';\r\n}\r\n\r\n// helper: convert ISO -> date string accepted by Frappe (YYYY-MM-DD)\r\nfunction toLocalDateStr(iso?: string|null) {\r\n  if (!iso) return null;\r\n  const d = new Date(iso);\r\n  if (isNaN(d.getTime())) return null;\r\n  const yyyy = d.getFullYear();\r\n  const mm = String(d.getMonth()+1).padStart(2,'0');\r\n  const dd = String(d.getDate()).padStart(2,'0');\r\n  const hh = String(d.getHours()).padStart(2,'0');\r\n  const min = String(d.getMinutes()).padStart(2,'0');\r\n  // frappe accepts start and end with times too: \"YYYY-MM-DD HH:mm\"\r\n  return `${yyyy}-${mm}-${dd} ${hh}:${min}`;\r\n}\r\n\r\nexport default function FrappeGanttChart({ pageSize = 2000 }: { pageSize?: number }) {\r\n  const containerRef = useRef<HTMLDivElement | null>(null);\r\n  const ganttRef = useRef<any>(null);\r\n  const [items, setItems] = useState<WO[]>([]);\r\n  const [selected, setSelected] = useState<WO|null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string|null>(null);\r\n\r\n  useEffect(() => { load(); }, []);\r\n\r\n  async function load() {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const res = await apiClient(`/work-orders?q=&page=1&pageSize=${pageSize}`);\r\n      const rows = res?.data ?? res;\r\n      const mapped: WO[] = (rows || []).map((r: any) => ({\r\n        ...r,\r\n        start_date: r.start_date ?? null,\r\n        end_date: r.end_date ?? null,\r\n        description: r.description ?? r.raw?.description ?? '',\r\n      }));\r\n      setItems(mapped);\r\n    } catch (err: any) {\r\n      console.error('load gantt', err);\r\n      setError(err.body?.message || err.message || 'Gagal memuat data');\r\n    } finally { setLoading(false); }\r\n  }\r\n\r\n  // re-create gantt whenever items change\r\n  useEffect(() => {\r\n    if (!containerRef.current) return;\r\n    // prepare tasks for frappe\r\n    const tasks = items.map(it => {\r\n      const start = toLocalDateStr(it.start_date) ?? toLocalDateStr(it.end_date);\r\n      const end = toLocalDateStr(it.end_date) ?? toLocalDateStr(it.start_date);\r\n      // fallback skip invalid\r\n      if (!start || !end) return null;\r\n      return {\r\n        id: it.id,\r\n        name: `${it.doc_no} â€” ${it.asset_name ?? ''}`,\r\n        start,\r\n        end,\r\n        progress: 0,\r\n        // custom class used for color via CSS variable fallback\r\n        custom_class: 'fg-task-' + (Math.abs(hashCode(it.id)) % 10),\r\n        data: it, // attach raw\r\n      };\r\n    }).filter(Boolean);\r\n\r\n    // remove previous gantt if exists\r\n    if (ganttRef.current && ganttRef.current.$svg) {\r\n      // destroy: frappe doesn't provide destroy API; clear container\r\n      containerRef.current.innerHTML = '';\r\n      ganttRef.current = null;\r\n    }\r\n\r\n    // create new gantt\r\n    try {\r\n      const gantt = new Gantt(containerRef.current!, tasks, {\r\n        view_mode: 'Day', // show per-day initially\r\n        date_format: 'YYYY-MM-DD HH:mm',\r\n        on_click: (task: any) => {\r\n          // task is the task object; it has .data pointing to origin WO\r\n          setSelected(task.data || null);\r\n        },\r\n        on_date_change: (task: any, start: any, end: any) => {\r\n          // optional: handle drag/resizing if you enable; ignore here\r\n          console.log('date change', task, start, end);\r\n        },\r\n        on_view_change: (mode: any) => {\r\n          // mode can be 'Quarter Day','Half Day','Day','Week','Month'\r\n          // you can react to mode change if needed\r\n          // console.log('view change', mode);\r\n        },\r\n      });\r\n      ganttRef.current = gantt;\r\n      // set task color by injecting CSS rules by custom_class mapping\r\n      // we set background-fill using inline style on DOM via querySelector\r\n      setTimeout(() => {\r\n        try {\r\n          tasks.forEach((t: any) => {\r\n            const el = containerRef.current!.querySelector(`[data-id=\"${t.id}\"] .bar`);\r\n            if (el) {\r\n              // color pick from original item\r\n              const color = pickColorForWork(t.data);\r\n              (el as HTMLElement).style.fill = color;\r\n              (el as HTMLElement).style.stroke = color;\r\n            }\r\n          });\r\n        } catch (e) { /* ignore */ }\r\n      }, 100);\r\n    } catch (e) {\r\n      console.error('frappe create error', e);\r\n    }\r\n  }, [items]);\r\n\r\n  return (\r\n    <div style={{ padding: 12 }}>\r\n      <h3>Gantt (Frappe)</h3>\r\n      <div style={{ marginBottom: 8 }}>\r\n        <button onClick={load} disabled={loading}>Refresh</button>\r\n      </div>\r\n\r\n      {loading && <div>Loading...</div>}\r\n      {error && <div style={{ color: 'red' }}>{error}</div>}\r\n\r\n      <div style={{ border: '1px solid #eee', borderRadius: 6, overflowX: 'auto' }}>\r\n        <div ref={containerRef} />\r\n      </div>\r\n\r\n      {/* modal */}\r\n      {selected && (\r\n        <div style={{\r\n          position: 'fixed', left:0, right:0, top:0, bottom:0, background:'rgba(0,0,0,0.35)',\r\n          display:'flex', alignItems:'center', justifyContent:'center'\r\n        }}>\r\n          <div style={{ background:'white', width:720, maxHeight:'80%', overflowY:'auto', padding:16, borderRadius:8 }}>\r\n            <h4>{selected.doc_no ?? selected.description}</h4>\r\n            <div><strong>Asset:</strong> {selected.asset_name}</div>\r\n            <div><strong>Type:</strong> {selected.work_type}</div>\r\n            <div><strong>Start:</strong> {selected.start_date}</div>\r\n            <div><strong>End:</strong> {selected.end_date}</div>\r\n            <pre style={{ whiteSpace:'pre-wrap', background:'#f7f7f7', padding:8 }}>{JSON.stringify(selected.raw ?? selected, null, 2)}</pre>\r\n            <div style={{ textAlign:'right' }}>\r\n              <button onClick={() => setSelected(null)}>Close</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n// small helper: hash string to number\r\nfunction hashCode(str: string) {\r\n  let h = 0;\r\n  for (let i = 0; i < str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0;\r\n  return h;\r\n}\r\n"],"names":[],"mappings":"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"}}]
}