{"version":3,"sources":["../../../../../web/app/asignments/page.jsx"],"sourcesContent":["// filepath: web/app/assignments/page.jsx\r\n\"use client\";\r\nimport React, { useEffect, useState } from \"react\";\r\nimport { apiFetch, uploadFilePresign } from \"../../lib/api-client\";\r\n\r\nexport default function AssignmentsPage() {\r\n  const [assignments, setAssignments] = useState([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [selectedFiles, setSelectedFiles] = useState([]);\r\n  const [signatureFile, setSignatureFile] = useState(null);\r\n  const [selectedAssignment, setSelectedAssignment] = useState(null);\r\n  const [submitting, setSubmitting] = useState(false);\r\n  const userId = typeof window !== \"undefined\" ? localStorage.getItem(\"userId\") : null;\r\n\r\n  useEffect(() => {\r\n    fetchList();\r\n  }, []);\r\n\r\n  async function fetchList() {\r\n    setLoading(true);\r\n    try {\r\n      const q = userId ? `?user=${encodeURIComponent(userId)}` : \"\";\r\n      const data = await apiFetch(`/assignments${q}`);\r\n      setAssignments(Array.isArray(data) ? data : (data.items || []));\r\n    } catch (err) {\r\n      console.error(\"fetch assignments error\", err);\r\n      setAssignments([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }\r\n\r\n  function onFiles(e) {\r\n    setSelectedFiles(Array.from(e.target.files || []));\r\n  }\r\n  function onSignature(e) {\r\n    setSignatureFile((e.target.files && e.target.files[0]) || null);\r\n  }\r\n\r\n  async function submitRealisasi() {\r\n    if (!selectedAssignment) {\r\n      alert(\"Select assignment first\");\r\n      return;\r\n    }\r\n    setSubmitting(true);\r\n    try {\r\n      // Option A: upload files via presign then send JSON payload with URLs\r\n      const photoUrls = [];\r\n      for (const f of selectedFiles) {\r\n        const uploaded = await uploadFilePresign(f);\r\n        photoUrls.push(uploaded.url);\r\n      }\r\n      let signatureUrl = null;\r\n      if (signatureFile) {\r\n        const uploaded = await uploadFilePresign(signatureFile);\r\n        signatureUrl = uploaded.url;\r\n      }\r\n\r\n      const payload = {\r\n        wo_id: selectedAssignment.work_order_id || selectedAssignment.work_order?.wo_id || null,\r\n        assignment_id: selectedAssignment.id,\r\n        start_time: new Date().toISOString(),\r\n        end_time: new Date().toISOString(),\r\n        actions_taken: \"Submitted from web UI\",\r\n        man_hours: 1.0,\r\n        notes: \"Uploaded from Next.js web\",\r\n        photos: photoUrls,\r\n        signature: signatureUrl,\r\n      };\r\n\r\n      // Server accepts JSON with file URLs (also supports multipart)\r\n      const res = await apiFetch(\"/realisasi\", { method: \"POST\", body: payload });\r\n      alert(\"Realisasi submitted: \" + (res.realisasi_id || res.id || \"ok\"));\r\n      // refresh list\r\n      fetchList();\r\n      // clear\r\n      setSelectedFiles([]);\r\n      setSignatureFile(null);\r\n      setSelectedAssignment(null);\r\n    } catch (err) {\r\n      console.error(err);\r\n      alert(\"Submit failed: \" + (err.message || \"error\"));\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div style={{ padding: 20 }}>\r\n      <h1>Assignments</h1>\r\n      {loading ? (\r\n        <div>Loading...</div>\r\n      ) : (\r\n        <>\r\n          <ul>\r\n            {assignments.map((a) => (\r\n              <li key={a.id} style={{ marginBottom: 8 }}>\r\n                <strong>{a.work_order?.title || a.work_order_id}</strong>\r\n                <div>Assignee: {a.assignee_id}</div>\r\n                <div>Status: {a.status}</div>\r\n                <button onClick={() => setSelectedAssignment(a)} style={{ marginTop: 6 }}>\r\n                  Select\r\n                </button>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n\r\n          <hr />\r\n\r\n          <h2>Submit Realisasi</h2>\r\n          <div>\r\n            <div>Selected assignment: {selectedAssignment ? selectedAssignment.id : \"â€”\"}</div>\r\n            <input type=\"file\" multiple onChange={onFiles} />\r\n            <div style={{ marginTop: 8 }}>\r\n              <label>Signature (PNG): </label>\r\n              <input type=\"file\" accept=\"image/png\" onChange={onSignature} />\r\n            </div>\r\n            <div style={{ marginTop: 12 }}>\r\n              <button onClick={submitRealisasi} disabled={submitting || !selectedAssignment}>\r\n                {submitting ? \"Submitting...\" : \"Submit Realisasi\"}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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"}